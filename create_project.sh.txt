#!/bin/bash
set -e

# =========================================================
# CHECK ROOT
# =========================================================
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root (use sudo)"
  exit 1
fi

# =========================================================
# DOMAIN INPUT
# =========================================================
PROJECT_DOMAIN="$1"
if [ -z "$PROJECT_DOMAIN" ]; then
  echo "Usage: $0 yourdomain.com"
  exit 1
fi

PROJECT_NAME=$(echo "$PROJECT_DOMAIN" | cut -d '.' -f1)

BASE_PATH="/var/www/vhost-live/$PROJECT_NAME"
HTTPDOCS="$BASE_PATH/httpdocs"
LOGS="$BASE_PATH/logs"
BACKUP="$BASE_PATH/backup"
SOURCE_DIR="$BASE_PATH/source_code"
CONFIG_DIR="$BASE_PATH/config"

PROJECT_NGINX_CONF="$CONFIG_DIR/include.conf"
MAIN_NGINX_CONF="/etc/nginx/sites-available/ZZzmahendra.conf"

mkdir -p "$HTTPDOCS" "$LOGS" "$BACKUP" "$SOURCE_DIR" "$CONFIG_DIR"
chown -R www-data:www-data "$BASE_PATH"

cd "$SOURCE_DIR"

# =========================================================
# PROJECT TYPE
# =========================================================
echo "Select Project Type:"
echo "1) .NET"
echo "2) Angular"
read -p "Enter choice (1/2): " PROJECT_TYPE

DOTNET_PROJECT=false
ANGULAR_PROJECT=false

if [ "$PROJECT_TYPE" == "1" ]; then
    DOTNET_PROJECT=true
elif [ "$PROJECT_TYPE" == "2" ]; then
    ANGULAR_PROJECT=true
else
    echo "Invalid selection."
    exit 1
fi

# =========================================================
# GIT
# =========================================================
echo "Git is mandatory for deployment."

read -p "Enter Git Repository URL: " REPO
read -p "Enter Branch Name: " BRANCH

if git ls-remote "$REPO" &>/dev/null; then
    CLONE_URL="$REPO"
else
    read -p "Git Username: " GUSER
    read -s -p "Git Token/Password: " GTOKEN
    echo ""
    CLONE_URL=$(echo "$REPO" | sed "s#https://#https://$GUSER:$GTOKEN@#")
fi

git config --global --add safe.directory "$SOURCE_DIR" || true

if [ -d ".git" ]; then
    sudo -u www-data git fetch origin
    sudo -u www-data git reset --hard origin/"$BRANCH"
else
    sudo -u www-data git clone -b "$BRANCH" "$CLONE_URL" .
fi

# =========================================================
# BUILD
# =========================================================
rm -rf "$HTTPDOCS"/*
mkdir -p "$HTTPDOCS"

if $DOTNET_PROJECT; then

    echo "Searching for .NET project file..."

    mapfile -t ALL_PROJECTS < <(find . -type f -name "*.csproj" \
      ! -path "*/bin/*" \
      ! -path "*/obj/*")

    if [ ${#ALL_PROJECTS[@]} -eq 0 ]; then
        echo "No .csproj file found in repository!"
        exit 1
    fi

    # Try to detect Web SDK project
    WEB_PROJECT=""
    for proj in "${ALL_PROJECTS[@]}"; do
        if grep -q "Microsoft.NET.Sdk.Web" "$proj"; then
            WEB_PROJECT="$proj"
            break
        fi
    done

    if [ -n "$WEB_PROJECT" ]; then
        CSPROJ_FILE="$WEB_PROJECT"
    else
        if [ ${#ALL_PROJECTS[@]} -gt 1 ]; then
            echo "Multiple projects found:"
            select choice in "${ALL_PROJECTS[@]}"; do
                CSPROJ_FILE="$choice"
                break
            done
        else
            CSPROJ_FILE="${ALL_PROJECTS[0]}"
        fi
    fi

    echo "Selected Project: $CSPROJ_FILE"

    # Detect environment files
    mapfile -t ENV_FILES < <(find . -name "appsettings.*.json" ! -name "appsettings.json")

    if [ ${#ENV_FILES[@]} -eq 0 ]; then
        ASP_ENV="Production"
    else
        echo "Available Environments:"
        for i in "${!ENV_FILES[@]}"; do
            FILE=$(basename "${ENV_FILES[$i]}")
            ENV_NAME=$(echo "$FILE" | sed 's/appsettings.//' | sed 's/.json//')
            echo "$((i+1))) $ENV_NAME"
        done

        read -p "Select environment number: " ENV_CHOICE
        INDEX=$((ENV_CHOICE-1))
        FILE=$(basename "${ENV_FILES[$INDEX]}")
        ASP_ENV=$(echo "$FILE" | sed 's/appsettings.//' | sed 's/.json//')
    fi

    DOTNET_PORT=5000
    while lsof -i:$DOTNET_PORT >/dev/null 2>&1; do
        DOTNET_PORT=$((DOTNET_PORT+1))
    done

    dotnet restore "$CSPROJ_FILE"
    dotnet publish "$CSPROJ_FILE" -c Release -o "$HTTPDOCS"

    DLL_NAME=$(basename "$CSPROJ_FILE" .csproj).dll

elif $ANGULAR_PROJECT; then

    read -p "Build Type (production/development): " BUILD_TYPE

    sudo -u www-data npm install
    sudo -u www-data npx ng build --configuration="$BUILD_TYPE"

    DIST_FOLDER=$(ls dist | head -n1)
    cp -r "dist/$DIST_FOLDER/"* "$HTTPDOCS/"
fi

chown -R www-data:www-data "$HTTPDOCS"

# =========================================================
# SYSTEMD (.NET ONLY)
# =========================================================
if $DOTNET_PROJECT; then

SERVICE_FILE="/etc/systemd/system/$PROJECT_NAME.service"

cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=$PROJECT_NAME .NET Service
After=network.target

[Service]
WorkingDirectory=$HTTPDOCS
ExecStart=/usr/bin/dotnet $HTTPDOCS/$DLL_NAME
Restart=always
RestartSec=5
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=$ASP_ENV
Environment=ASPNETCORE_URLS=http://0.0.0.0:$DOTNET_PORT

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable "$PROJECT_NAME"
systemctl restart "$PROJECT_NAME"

fi

# =========================================================
# NGINX CONFIG
# =========================================================
cat > "$PROJECT_NGINX_CONF" <<EOF
server {
    listen 80;
    server_name $PROJECT_DOMAIN;
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name $PROJECT_DOMAIN;

    ssl_certificate /etc/ssl/certs/wildcard.mahendra.com.crt;
    ssl_certificate_key /etc/ssl/private/wildcard.mahendra.com.key;
EOF

if $ANGULAR_PROJECT; then
cat >> "$PROJECT_NGINX_CONF" <<EOF
    root $HTTPDOCS;
    index index.html;

    location / {
        try_files \$uri \$uri/ /index.html;
    }
EOF
fi

if $DOTNET_PROJECT; then
cat >> "$PROJECT_NGINX_CONF" <<EOF
    location / {
        proxy_pass http://127.0.0.1:$DOTNET_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
EOF
fi

echo "}" >> "$PROJECT_NGINX_CONF"

if [ ! -f "$MAIN_NGINX_CONF" ]; then
    touch "$MAIN_NGINX_CONF"
fi

if ! grep -q "$PROJECT_NGINX_CONF" "$MAIN_NGINX_CONF"; then
    echo "include $PROJECT_NGINX_CONF;" >> "$MAIN_NGINX_CONF"
fi

ln -sf "$MAIN_NGINX_CONF" /etc/nginx/sites-enabled/ZZzmahendra.conf

nginx -t
systemctl reload nginx

# =========================================================
# FINAL OUTPUT
# =========================================================
echo ""
echo "======================================"
echo "Project Deployed Successfully"
echo "URL: https://$PROJECT_DOMAIN"

if $DOTNET_PROJECT; then
  echo "Dotnet Port: $DOTNET_PORT"
  echo "Service Status: $(systemctl is-active $PROJECT_NAME)"
fi

echo "======================================"
echo ""
