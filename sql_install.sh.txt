#!/bin/bash
set -e

# =========================================================
# CHECK ROOT
# =========================================================
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root (use sudo)"
  exit 1
fi

# =========================================================
# CHECK OS VERSION (Ubuntu 22.04 Only)
# =========================================================
OS_VERSION=$(lsb_release -rs)

if [ "$OS_VERSION" != "22.04" ]; then
  echo "This script supports Ubuntu 22.04 LTS only."
  exit 1
fi

echo "Updating system..."
apt update -y && apt upgrade -y

apt install -y wget curl gnupg apt-transport-https software-properties-common openssl

# -----------------------------
# Select MSSQL Version
# -----------------------------
echo ""
echo "Select SQL Server Version:"
echo "1) SQL Server 2019"
echo "2) SQL Server 2022 (Recommended)"
read -p "Enter choice [1-2]: " VERSION_CHOICE

if [ "$VERSION_CHOICE" == "1" ]; then
    MSSQL_VERSION="2019"
elif [ "$VERSION_CHOICE" == "2" ]; then
    MSSQL_VERSION="2022"
else
    echo "Invalid choice. Defaulting to 2022."
    MSSQL_VERSION="2022"
fi

# -----------------------------
# Select Edition
# -----------------------------
echo ""
echo "Select Edition:"
echo "1) Developer"
echo "2) Standard"
echo "3) Express"
echo "4) Enterprise"
echo "5) Use Product Key"
read -p "Enter choice [1-5]: " EDITION_CHOICE

PRODUCT_KEY=""
case $EDITION_CHOICE in
    1) MSSQL_PID="Developer" ;;
    2) MSSQL_PID="Standard" ;;
    3) MSSQL_PID="Express" ;;
    4) MSSQL_PID="Enterprise" ;;
    5)
        read -p "Enter Product Key: " PRODUCT_KEY
        MSSQL_PID="$PRODUCT_KEY"
        ;;
    *)
        echo "Invalid choice. Defaulting to Developer."
        MSSQL_PID="Developer"
        ;;
esac

# -----------------------------
# Generate SA Password
# -----------------------------
SA_PASSWORD=$(openssl rand -base64 24 | tr -dc 'A-Za-z0-9@#%_' | head -c 20)

# -----------------------------
# Add Microsoft GPG Key (Modern Method)
# -----------------------------
echo "Adding Microsoft repository..."

mkdir -p /etc/apt/keyrings
curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg
chmod go+r /etc/apt/keyrings/microsoft.gpg

# Remove old repo if exists
rm -f /etc/apt/sources.list.d/mssql-server.list
rm -f /etc/apt/sources.list.d/msprod.list

# Add MSSQL Server Repo
echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/ubuntu/22.04/mssql-server-${MSSQL_VERSION} jammy main" \
> /etc/apt/sources.list.d/mssql-server.list

# Add Tools Repo
echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/ubuntu/22.04/prod jammy main" \
> /etc/apt/sources.list.d/msprod.list

apt update -y

# -----------------------------
# Install MSSQL Server
# -----------------------------
apt install -y mssql-server

# -----------------------------
# Configure MSSQL
# -----------------------------
echo "Configuring SQL Server..."
MSSQL_SA_PASSWORD="$SA_PASSWORD" MSSQL_PID="$MSSQL_PID" /opt/mssql/bin/mssql-conf -n setup accept-eula

# -----------------------------
# Install SQL Tools
# -----------------------------
apt install -y mssql-tools unixodbc-dev

echo 'export PATH="$PATH:/opt/mssql-tools/bin"' > /etc/profile.d/mssql.sh
chmod +x /etc/profile.d/mssql.sh

# -----------------------------
# Enable & Start Service
# -----------------------------
systemctl enable mssql-server
systemctl restart mssql-server

# Verify Service
if systemctl is-active --quiet mssql-server; then
    echo "SQL Server service is running."
else
    echo "SQL Server failed to start."
    exit 1
fi

# -----------------------------
# Save Inventory Securely
# -----------------------------
echo "Saving configuration to /etc/.sql ..."

cat > /etc/.sql <<EOF
MSSQL_VERSION=$MSSQL_VERSION
MSSQL_EDITION=$MSSQL_PID
MSSQL_HOST=localhost
MSSQL_USER=sa
MSSQL_PASSWORD=$SA_PASSWORD
MSSQL_PRODUCT_KEY=$PRODUCT_KEY
INSTALL_DATE=$(date)
EOF

chmod 600 /etc/.sql

# -----------------------------
# Final Output
# -----------------------------
echo ""
echo "======================================"
echo "SQL Server Installed Successfully!"
echo "======================================"
echo "Version     : $MSSQL_VERSION"
echo "Edition     : $MSSQL_PID"
echo "Host        : localhost"
echo "Username    : sa"
echo "SA Password : $SA_PASSWORD"

if [ ! -z "$PRODUCT_KEY" ]; then
    echo "Product Key : $PRODUCT_KEY"
fi

echo ""
echo "Inventory saved at: /etc/.sql"
echo "======================================"
